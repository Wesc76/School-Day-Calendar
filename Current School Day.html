<!DOCTYPE html>
<html>
  <head>
    <title>Current School Day</title>
  </head>
  <body>
    <h1>Current School Day</h1>
    <p>The current date is: <span id="currentDate"></span></p>
    <p><strong>School Day Events:</strong></p>
    <ul id="eventsList"></ul>
    <script src="https://unpkg.com/ical.js/build/ical.js"></script>
    <script>
      // Get the current date and time
      var today = new Date();
      
      // Format the date as YYYY-MM-DD
      var year = today.getFullYear();
      var month = (today.getMonth() + 1).toString().padStart(2, '0');
      var day = today.getDate().toString().padStart(2, '0');
      var formattedDate = year + '-' + month + '-' + day;
      
      // Display the formatted date on the page
      document.getElementById('currentDate').textContent = formattedDate;
      
      // Retrieve the ICS file
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://sbwsdstor.blob.core.windows.net/media/Default/frf/5/WSD%20School%20Day%20Calendar-3.ics');
      xhr.onload = function() {
        if (xhr.status === 200) {
          var data = xhr.responseText;
          
          // Parse the ICS file using the ICAL.js library
          var calendar = ICAL.parse(data);
          var comp = new ICAL.Component(calendar);
          var vevents = comp.getAllSubcomponents('vevent');
          
          // Filter the events for today's date
          var todaysEvents = vevents.filter(function(vevent) {
            var eventStart = vevent.getFirstPropertyValue('dtstart').toJSDate();
            var eventEnd = vevent.getFirstPropertyValue('dtend').toJSDate();
            return eventStart <= today && eventEnd >= today;
          });
          
          // Display the list of events on the page
          var eventsList = document.getElementById('eventsList');
          if (todaysEvents.length > 0) {
            todaysEvents.forEach(function(vevent) {
              var summary = vevent.getFirstPropertyValue('summary');
              var location = vevent.getFirstPropertyValue('location');
              var description = vevent.getFirstPropertyValue('description');
              var eventHtml = '<li><strong>' + summary + '</strong>';
              if (location) {
                eventHtml += ' (' + location + ')';
              }
              if (description) {
                eventHtml += '<br>' + description;
              }
              eventHtml += '</li>';
              eventsList.innerHTML += eventHtml;
            });
          } else {
            eventsList.innerHTML = '<li>No events scheduled for today</li>';
          }
        } else {
          // Display an error message if the request fails
          var eventsList = document.getElementById('eventsList');
          eventsList.innerHTML = '<li>Error retrieving school day events</li>';
        }
      };
      xhr.onerror = function() {
        // Display an error message if the request fails
        var eventsList = document.getElementById('eventsList');
        eventsList.innerHTML = '<li>Error retrieving school day events</li>';
      };
      xhr.send();
    </script>
  </body>
</html>
